<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calc · Баллистический калькулятор</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <main class="shell">
      <header class="shell-header">
        <p class="logo-label" data-i18n="appVersion">Calc v1</p>
        <h1 data-i18n="appTitle">Баллистический калькулятор</h1>
        <p class="subtitle" data-i18n="appSubtitle">
          Единая оболочка для планирования огневых задач и оперативных данных.
        </p>
      </header>

      <nav class="tabs" aria-label="Sections">
        <button class="tab active" data-tab="home" data-i18n="tabHome" data-i18n-title="tipTabHome">Главная</button>
        <button class="tab" data-tab="global" data-i18n="tabGlobal" data-i18n-title="tipTabGlobal">Глобальные настройки</button>
        <button class="tab" data-tab="fire" data-i18n="tabFire" data-i18n-title="tipTabFire">Огневые задачи</button>
        <button class="tab" data-tab="counter-battery" data-i18n="tabCounterBattery">Контрбатарейная борьба</button>
        <button class="tab" data-tab="map" data-i18n="tabMap" data-i18n-title="tipTabMap">Карта</button>
        <button class="tab" data-tab="safety" data-i18n="tabSafety" data-i18n-title="tipTabSafety">Безопасность и данные</button>
        <button class="tab" data-tab="settings" data-i18n="tabSettings" data-i18n-title="tipTabSettings">Настройки</button>
      </nav>

      <section class="tab-panel active" data-panel="home">
        <div class="panel-grid panel-grid-3">
          <article class="card" data-i18n-title="tipHomeGlobalCard">
            <h2 data-i18n="homeConfiguration">Глобальные настройки</h2>
            <div class="card-actions">
              <button class="btn" data-open-tab="global" data-i18n="editGlobalData">Настроить орудия, батареи и наблюдателей</button>
              <a class="btn ghost" href="http://localhost:8000/docs" target="_blank" rel="noreferrer" data-i18n="openApi">Открыть API</a>
            </div>
          </article>

          <article class="card" data-i18n-title="tipHomeFireCard">
            <h2 data-i18n="homeFire">Огневые задачи</h2>
            <div class="card-actions">
              <button class="btn" data-open-tab="fire" data-i18n="openMissionPlanner">Открыть вкладку задач</button>
              <button class="btn ghost" id="health-check" data-i18n="checkServices">Проверить сервисы</button>
            </div>
          </article>

          <article class="card" data-i18n-title="tipHomeMapCard">
            <h2 data-i18n="homeMap">Карта и интеграции</h2>
            <label for="map-url" data-i18n="mapUrl">URL карты</label>
            <input id="map-url" type="url" placeholder="http://localhost:4173" />
            <div class="card-actions">
              <button class="btn" id="open-map" data-i18n="openMap">Открыть карту</button>
            </div>
          </article>
        </div>



        <div class="status-line">
          <p class="status" data-service="ballistics"></p>
        </div>
      </section>

      <section class="tab-panel" data-panel="global">
        <div class="section-layout global-layout">
          <article class="card global-card">
            <h2 data-i18n="batterySectionTitle">Батареи</h2>
            <div class="global-control">
              <label for="battery-count" data-i18n="batteryCount">Количество батарей</label>
              <input id="battery-count" type="number" min="1" max="5" value="2" />
            </div>
            <div id="battery-config" class="stack"></div>
          </article>
          <article class="card global-card">
            <h2 data-i18n="gunsSectionTitle">Орудия</h2>
            <div id="guns-coordinates" class="stack"></div>
          </article>
          <article class="card global-card">
            <h2 data-i18n="observerSectionTitle">Наблюдатели</h2>
            <div class="global-control">
              <label for="observer-count" data-i18n="observerCount">Количество наблюдателей (до 5)</label>
              <input id="observer-count" type="number" min="1" max="5" value="2" />
            </div>
            <div id="observer-bindings" class="stack"></div>
          </article>
        </div>
      </section>

      <section class="tab-panel" data-panel="fire">
        <div class="section-layout">
          <article class="card">
            <h2 data-i18n="missionTitle">Калькулятор огневой задачи</h2>
            <label for="mission-name" data-i18n="missionName">Название задачи</label>
            <input id="mission-name" value="Mission-1" />
            <label for="active-target" data-i18n="activeTargetLabel">Активная цель</label>
            <select id="active-target"></select>
            <div class="pair pair-3">
              <label><input id="target-active-1" type="checkbox" checked /> Ц-1</label>
              <label><input id="target-active-2" type="checkbox" /> Ц-2</label>
              <label><input id="target-active-3" type="checkbox" /> Ц-3</label>
            </div>
            <label for="target-x" data-i18n="targetX">Координата цели X</label>
            <input id="target-x" type="text" inputmode="numeric" data-coordinate value="1500" />
            <label for="target-y" data-i18n="targetY">Координата цели Y</label>
            <input id="target-y" type="text" inputmode="numeric" data-coordinate value="1800" />
            <label for="mission-battery" data-i18n="missionBattery">Батарея</label>
            <select id="mission-battery"></select>
            <label for="mission-gun" data-i18n="missionGun">Орудие (или все в батарее)</label>
            <select id="mission-gun"></select>
            <h3 data-i18n="missionProjectileSelectionTitle">Выбор снарядов по типам орудий</h3>
            <p class="hint" data-i18n="missionProjectileSelectionHint">Снаряд выбирается отдельно для каждого типа орудия, участвующего в задаче.</p>
            <div id="mission-projectile-selectors" class="stack compact-stack"></div>
            <label for="fire-mode" data-i18n="fireMode">Тип огня</label>
            <select id="fire-mode">
              <option value="linear" data-i18n="fireModeLinear">Линейный сноп</option>
              <option value="parallel" data-i18n="fireModeParallel">Параллельный</option>
              <option value="converging" data-i18n="fireModeConverging">Сходящийся</option>
              <option value="open" data-i18n="fireModeOpen">Открытый</option>
              <option value="circular" data-i18n="fireModeCircular">Круговой</option>
            </select>
            <div id="fire-mode-settings" class="stack compact-stack">
              <div data-fire-mode-panel="linear" class="pair pair-2">
                <input id="fire-linear-start-x" type="text" inputmode="numeric" data-coordinate data-fire-setting="linearStartX" placeholder="Start X" />
                <input id="fire-linear-start-y" type="text" inputmode="numeric" data-coordinate data-fire-setting="linearStartY" placeholder="Start Y" />
                <input id="fire-linear-end-x" type="text" inputmode="numeric" data-coordinate data-fire-setting="linearEndX" placeholder="End X" />
                <input id="fire-linear-end-y" type="text" inputmode="numeric" data-coordinate data-fire-setting="linearEndY" placeholder="End Y" />
              </div>
              <div data-fire-mode-panel="parallel" class="pair pair-2 hidden">
                <input id="fire-parallel-width" type="number" min="10" step="10" data-fire-setting="parallelWidth" placeholder="Width (m)" />
                <input id="fire-parallel-lanes" type="number" min="2" max="10" step="1" data-fire-setting="parallelLanes" placeholder="Lanes" />
              </div>
              <div data-fire-mode-panel="converging" class="pair pair-2 hidden">
                <input id="fire-converging-radius" type="number" min="10" step="10" data-fire-setting="convergingRadius" placeholder="Radius (m)" />
                <input id="fire-converging-azimuth" type="number" min="0" max="359" step="1" data-fire-setting="convergingAzimuth" placeholder="Azimuth°" />
              </div>
              <div data-fire-mode-panel="open" class="pair pair-2 hidden">
                <input id="fire-open-width" type="number" min="10" step="10" data-fire-setting="openWidth" placeholder="Width (m)" />
                <input id="fire-open-depth" type="number" min="10" step="10" data-fire-setting="openDepth" placeholder="Depth (m)" />
              </div>
              <div data-fire-mode-panel="circular" class="pair pair-2 hidden">
                <input id="fire-circular-radius" type="number" min="10" step="10" data-fire-setting="circularRadius" placeholder="Radius (m)" />
                <input id="fire-circular-count" type="number" min="4" max="24" step="1" data-fire-setting="circularCount" placeholder="Points" />
              </div>
            </div>
          </article>
          <article class="card">
            <h2 data-i18n="actionsTitle">Действия</h2>
            <p class="hint" data-i18n="gunnerHint">Все расчёты выполняются на основе глобальных настроек.</p>
            <h3 data-i18n="correctionTitle">Корректировка</h3>
            <label for="correction-observer" data-i18n="correctionObserver">Наблюдатель корректировки</label>
            <select id="correction-observer"></select>
            <p id="correction-anchor-info" class="hint"></p>
            <div class="pair pair-2">
              <input id="correction-lr" type="number" step="1" placeholder="L/R (m)" />
              <input id="correction-add-drop" type="number" step="1" placeholder="Add/Drop (m)" />
            </div>
            <div class="card-actions inline-actions">
              <button class="btn ghost" id="save-correction" data-i18n="saveCorrection">Сохранить поправку</button>
              <button class="btn ghost" id="reset-correction" data-i18n="resetCorrection">Сбросить поправку</button>
            </div>
            <h3 data-i18n="observerTargetingTitle">Наведение наблюдателем</h3>
            <p class="hint" data-i18n="observerTargetingHint">Если координаты цели неизвестны, задайте дальность, азимут и угол.</p>
            <div class="pair pair-2">
              <input id="observer-target-distance" type="number" min="0" step="1" placeholder="Distance (m)" />
              <input id="observer-target-azimuth" type="number" min="0" max="359" step="0.1" placeholder="Azimuth°" />
              <input id="observer-target-angle" type="number" min="-89" max="89" step="0.1" placeholder="Angle°" />
            </div>
            <div class="card-actions inline-actions">
              <button class="btn ghost" id="apply-observer-targeting" data-i18n="applyObserverTargeting">Рассчитать цель от наблюдателя</button>
            </div>
            <div class="card-actions">
              <button class="btn" id="calculate-btn" data-i18n="calculate">Рассчитать</button>
              <button class="btn ghost" id="show-mto" data-i18n="showMto">Показать MTO</button>
              <button class="btn ghost" id="save-mission" data-i18n="logMission">Сохранить миссию</button>
            </div>
            <pre id="fire-output" class="output"></pre>
          </article>
        </div>
      </section>

      <section class="tab-panel" data-panel="map">
        <div class="section-layout map-layout">
          <article class="card map-card" data-i18n-title="tipMapCanvasCard">
            <h2 data-i18n="mapPanelTitle">Тактическая карта (Leaflet)</h2>
            <pre id="map-tools-output" class="output compact-output map-info-overlay"></pre>
            <div id="leaflet-map" class="leaflet-map" aria-label="Leaflet tactical map"></div>
          </article>
          <article class="card" data-i18n-title="tipMapToolsCard">
            <h2 data-i18n="mapLegendTitle">Легенда</h2>
            <p class="hint" data-i18n="mapLegendHint">Карта показывает орудия выбранной батареи и текущую цель из вкладки «Огневые задачи».</p>
            <div id="map-legend" class="stack"></div>

            <h2 data-i18n="mapToolsTitle">Инструменты меток</h2>
            <label for="marker-tool" data-i18n="markerToolLabel">Тип метки</label>
            <select id="marker-tool">
              <option value="gun" data-i18n="markerToolGun">Активное орудие</option>
              <option value="target" data-i18n="markerToolTarget">Цель</option>
                            <option value="observer" data-i18n="markerToolObserver">Наблюдатель</option>
              <option value="ruler" data-i18n="markerToolRuler">Линейка</option>
              <option value="coords" data-i18n="markerToolCoords">Снятие координат</option>
            </select>
            <label for="marker-target" data-i18n="markerTargetLabel">Активная цель метки</label>
            <select id="marker-target"></select>
            <div class="card-actions">
              <button class="btn" id="apply-manual-markers" data-i18n="applyManualMarkers">Применить ручные метки</button>
              <button class="btn ghost" id="clear-manual-markers" data-i18n="clearManualMarkers">Очистить ручные метки</button>
            </div>
            <details class="map-settings-accordion">
              <summary data-i18n="mapSettingsTitle">Настройки карты</summary>
              <div class="stack top-gap">
                <p class="hint" data-i18n="mapSettingsHint">Настройки карты скрыты и не мешают работе с метками.</p>
                <div class="card-actions">
                  <button class="btn ghost" id="toggle-calibration-mode" data-i18n="calibrationModeToggle">Калибровка: выкл</button>
                </div>
                <div id="calibration-controls" class="stack hidden">
                  <p class="hint" data-i18n="calibrationHint">Калибровка: включите режим, двойным щелчком ставьте метки P0/P1/P2 циклично. Введите только координаты P0 и длину P1-P2 в метрах.</p>
                  <p class="hint" id="calibration-last-info"></p>
                  <div class="pair pair-2">
                    <input id="cal-p0-x" type="number" placeholder="P0 X" />
                    <input id="cal-p0-y" type="number" placeholder="P0 Y" />
                  </div>
                  <div class="pair pair-1">
                    <input id="cal-scale-meters" type="number" min="0" step="0.1" placeholder="P1-P2 scale (m)" />
                  </div>
                  <div class="card-actions inline-actions">
                    <button class="btn ghost" id="apply-calibration" data-i18n="applyCalibration">Применить калибровку</button>
                    <button class="btn ghost" id="reset-calibration" data-i18n="resetCalibration">Сбросить калибровку</button>
                  </div>
                </div>
                <label for="map-image-upload" data-i18n="mapImageUpload">Загрузить свою карту (PNG/JPG)</label>
                <input id="map-image-upload" type="file" accept="image/png,image/jpeg,image/webp" />
                <div class="card-actions inline-actions">
                  <button class="btn ghost" id="paste-map-image" data-i18n="pasteMapImage">Вставить карту из буфера</button>
                  <button class="btn ghost" id="clear-map-image" data-i18n="clearMapImage">Убрать карту</button>
                </div>
              </div>
            </details>
          </article>
        </div>
      </section>

      <section class="tab-panel" data-panel="counter-battery">
        <div class="section-layout">
          <article class="card">
            <h2 data-i18n="counterBatteryTitle">Контрбатарейное обнаружение</h2>
            <p class="hint" data-i18n="counterBatteryHint">Используйте наблюдения для определения вражеского орудия: звук, воронки, триангуляция по азимутам и гиперболический TDOA.</p>
            <label for="cb-method" data-i18n="counterBatteryMethod">Метод определения</label>
            <select id="cb-method">
              <option value="sound-ranging" data-i18n="cbMethodSound">Звукопеленгация (sound ranging)</option>
              <option value="crater-analysis" data-i18n="cbMethodCrater">Анализ воронок и обратный азимут</option>
              <option value="azimuth-triangulation" data-i18n="cbMethodTriangulation">Триангуляция по азимутам наблюдателей</option>
              <option value="hyperbola-tdoa" data-i18n="cbMethodHyperbola">Гипербола по разности времени прихода (TDOA)</option>
            </select>
            <label for="cb-sound-bearing" data-i18n="cbBearing">Азимут на источник (°)</label>
            <input id="cb-sound-bearing" type="number" min="0" max="359.9" step="0.1" placeholder="52.5" />
            <label for="cb-est-distance" data-i18n="cbEstimatedDistance">Оценочная дальность (м)</label>
            <input id="cb-est-distance" type="number" min="0" step="10" placeholder="5200" />
            <label for="cb-tdoa-delta" data-i18n="cbTdoaDelta">Разница времени прихода (мс)</label>
            <input id="cb-tdoa-delta" type="number" step="1" placeholder="45" />
            <label for="cb-impact-bearing" data-i18n="cbImpactBearing">Обратный азимут от воронки (°)</label>
            <input id="cb-impact-bearing" type="number" min="0" max="359.9" step="0.1" placeholder="231" />
          </article>
          <article class="card">
            <h2 data-i18n="counterBatteryObservers">Данные наблюдателей</h2>
            <p class="hint" data-i18n="counterBatteryObserversHint">Наблюдатель докладывает азимут. Чем больше точек, тем точнее местоположение врага.</p>
            <div id="cb-observations" class="stack"></div>
            <div class="card-actions inline-actions">
              <button class="btn ghost" id="cb-add-point" data-i18n="cbAddPoint">Добавить точку</button>
              <button class="btn ghost" id="cb-clear-points" data-i18n="cbClearPoints">Очистить точки</button>
            </div>
            <div class="card-actions top-gap">
              <button class="btn" id="cb-locate-target" data-i18n="cbLocateTarget">Найти вражеское орудие</button>
              <button class="btn ghost" id="cb-calculate-response" data-i18n="cbCalculateResponse">Рассчитать ответный огонь</button>
            </div>
            <pre id="cb-output" class="output"></pre>
          </article>
        </div>
      </section>

      <section class="tab-panel" data-panel="safety">
        <div class="section-layout">
          <article class="card">
            <h2 data-i18n="safeDataTitle">Контроль данных</h2>
            <p data-i18n="safeDataDescription">Проверка журналов и экспорт служебных данных.</p>
            <div class="card-actions">
              <button class="btn ghost" id="open-logs" data-i18n="openLogs">Открыть логи</button>
              <button class="btn ghost" id="export-data" data-i18n="exportData">Экспорт данных</button>
              <button class="btn danger" id="clear-data" data-i18n="clearAllData">Очистить данные</button>
            </div>
            <pre id="safety-output" class="output compact-output"></pre>
          </article>
          <article class="card">
            <h2 data-i18n="serviceState">Состояние сервисов</h2>
            <p class="status info" data-service="ballistics-copy"></p>
          </article>
        </div>
      </section>

      <section class="tab-panel" data-panel="settings">
        <div class="section-layout">
          <article class="card">
            <h2 data-i18n="generalSettings">Общие настройки</h2>
            <label for="language" data-i18n="language">Язык</label>
            <select id="language">
              <option value="ru">Русский</option>
              <option value="en">English</option>
            </select>

            <label for="theme" data-i18n="theme">Тема</label>
            <select id="theme">
              <option value="terminal" data-i18n="themeTerminal">Terminal Green</option>
              <option value="midnight" data-i18n="themeMidnight">Midnight Blue</option>
            </select>
            <div class="card-actions top-gap">
              <button class="btn ghost" id="clear-browser-cache" data-i18n="clearBrowserCache">Очистить кэш браузера страницы</button>
            </div>
          </article>

          <article class="card">
            <h2 data-i18n="profilesTitle">Профили орудий и боеприпасов</h2>
            <p class="hint" data-i18n="profilesHint">Настройка сектора огня, зон минимальной/максимальной дальности и привязок к снарядам/таблицам.</p>
            <div id="profiles-editor" class="stack"></div>
          </article>
        </div>
      </section>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script type="module" src="/app.js"></script>
  </body>
</html>
